/*
 AGPLv2
 @author Alexandr Dubovikov <alexandr.dubovikov@gmail.com>

 Based on ocModal
 @author Olivier Combe <olivier.combe@gmail.com>
*/
(function(){angular.module("homer.cflow",[]).factory("$homerCflow",["$rootScope","$controller","$location","$timeout","$compile","$sniffer","$q","$filter",function(m,i,f,y,z,A,B,x){var q={},u,r,v,s,w,c;u=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.stroke()};v=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,
a.EndY);var e=Math.atan2(a.EndY-a.StartY,a.EndX-a.StartX);c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(e-Math.PI/6),a.EndY-10*Math.sin(e-Math.PI/6));c.moveTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(e+Math.PI/6),a.EndY-10*Math.sin(e+Math.PI/6));c.stroke()};r=function(a){c.beginPath();c.fillStyle=a.TextColor;c.font=a.Font;c.textAlign=a.textAlign;c.fillText(a.Text,a.StartX,a.StartY);c.stroke()};s=function(a){c.strokeStyle=a.TextColor;c.font=a.Font;return c.measureText(a.Text)};
w=function(a){c.beginPath();var e=new Image;e.src=a.ImageSrc;e.onload=function(){c.drawImage(e,a.StartX,a.StartY);c.stroke()}};return{waitingForOpen:!1,getOpenedModals:function(){return openedModals},register:function(a){q[a.id||"_default"]=a},remove:function(a){delete q[a||"_default"]},setContext:function(a,e){var i=[],j=angular.element(document.querySelectorAll("#"+a)),d=$(j).find("#cflowcanv")[0].getContext("2d");c=d;var g=$(j).height()-110,j=$(j).width()-20,f=e.calldata.length,f=f+3;50*f>g&&(g=
50*f);d.canvas.width=j;d.canvas.height=g;var m={},b={},h={width:0};d.clearRect(0,0,c.canvas.width,c.canvas.height);d.fillStyle="#FFF";d.opacity=0.2;d.fillRect(0,0,c.canvas.width,c.canvas.height);var j=j-20,g=g-30,d=Object.keys(e.hosts).length-1,k=j/(d?d:1),q=Object.keys(e.hosts).length;angular.forEach(e.hosts,function(a,c){a=parseInt(a);b={LineColor:"#000",LineWidth:1};b.StartX=a*k+10;b.StartY=65;b.EndX=a*k+10;b.EndY=g;u(b);m[c]=b;b={TextColor:"#666666"};b.Text=c;b.Font="normal 11px Arial";b.textAlign=
"start";b.StartY=60;h=s(b);var d=a*k-h.width/2+10,f=a*k-20;0==a?(d=a*k,f=a*k):a==q-1&&(d=a*k-h.width+15,f=a*k-30);b.StartX=d;r(b);i.push({x1:b.StartX,y1:b.StartY-10,x2:b.StartX+h.width,y2:b.StartY+10,type:"host"});d=e.uac[c];b={};b.ImageSrc=d&&d.image?"/img/gateways/"+d.image+".jpg":"/img/gateways/sipgateway.jpg";b.StartY=2;b.textAlign="start";b.StartX=f;w(b)});var g=g-130,n=g/(e.calldata.length-1?e.calldata.length-1:1);50>n&&(n=50);var p=0,l,t;angular.forEach(e.calldata,function(a){l=m[a.src_id];
t=m[a.dst_id];b={LineColor:"#000",LineWidth:1};b.StartX=l.StartX;b.StartY=p*n+110;b.EndX=t.StartX;b.EndY=p*n+110;v(b);b={};b.TextColor=a.msg_color;b.Text=""+(p+1)+": "+a.method_text;b.Font="12px Futura, Helvetica, Arial";h=s(b);b.StartY=p*n+107;b.StartX=l.StartX<t.StartX?l.StartX+20:l.StartX-20-h.width;b.textAlign="start";r(b);i.push({x1:b.StartX-10,y1:b.StartY-10,x2:b.StartX+h.width,y2:b.StartY+10,type:"message",data:a});b={TextColor:"#C0C0C0"};b.Text=x("date")(new Date(a.micro_ts/1E3),"yyyy-MM-dd HH:mm:ss.sss");
b.Font="lighter 8pt Arial";b.textAlign="start";h=s(b);b.StartY=p*n+122;b.StartX=l.StartX<t.StartX?l.StartX+20:l.StartX-20-h.width;p++;r(b)});return i}}}]).directive("canvasclick",function(){return{restrict:"EA",link:function(m,i){i.on("click",function(f){m.clickMousePosition(f)});i.on("mousemove",function(f){i.context.style.cursor=m.checkMousePosition(f)?"pointer":"default"})}}})})();
