/*
 AGPLv2
 @author Alexandr Dubovikov <alexandr.dubovikov@gmail.com>
 @author Lorenzo Mangani <lorenzo.mangani@gmail.com>

 Based on ocModal
 @author Olivier Combe <olivier.combe@gmail.com>
*/
(function(){angular.module("homer.cflow",[]).factory("$homerCflow",["$rootScope","$controller","$location","$timeout","$compile","$sniffer","$q","$filter",homer.modules.core.services.profile,function(z,u,d,H,q,I,J,F,G){var A={},B,v,C,w,D,E,c;B=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.stroke()};C=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,
a.StartY);c.lineTo(a.EndX,a.EndY);var e=Math.atan2(a.EndY-a.StartY,a.EndX-a.StartX);c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(e-Math.PI/6),a.EndY-10*Math.sin(e-Math.PI/6));c.moveTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(e+Math.PI/6),a.EndY-10*Math.sin(e+Math.PI/6));c.stroke()};v=function(a){c.beginPath();c.fillStyle=a.TextColor;c.font=a.Font;c.textAlign=a.textAlign;c.fillText(a.Text,a.StartX,a.StartY);c.stroke()};w=function(a){c.strokeStyle=a.TextColor;c.font=
a.Font;return c.measureText(a.Text)};D=function(a){c.beginPath();var e=new Image;e.src=a.ImageSrc;e.onload=function(){c.drawImage(e,a.StartX,a.StartY);c.stroke()}};E=function(a){for(var c=0,d=0;d<a.length;d++)c=a.charCodeAt(d)+((c<<5)-c);return"hsl("+(c>>24&255)+", 75%, 35%)"};return{waitingForOpen:!1,getOpenedModals:function(){return openedModals},register:function(a){A[a.id||"_default"]=a},remove:function(a){delete A[a||"_default"]},setContext:function(a,e){var d=G.getProfile("timezone"),q=[],l=
angular.element(document.querySelectorAll("#"+a)),g=$(l).find("#cflowcanv")[0].getContext("2d");c=g;var h=$(l).height()-110,l=$(l).width()-20,x=e.calldata.length,x=x+3;50*x>h&&(h=50*x);g.canvas.width=l;g.canvas.height=h;var p={},b={},k={width:0};g.clearRect(0,0,c.canvas.width,c.canvas.height);g.fillStyle="#FFF";g.opacity=.2;g.fillRect(0,0,c.canvas.width,c.canvas.height);var l=l-20,h=h-30,g=Object.keys(e.hosts).length-1,m=l/(g?g:1),u=Object.keys(e.hosts).length;angular.forEach(e.hosts,function(a,c){var f=
parseInt(a.position);b={LineColor:"#000",LineWidth:1};b.StartX=f*m+10;b.StartY=65;b.EndX=f*m+10;b.EndY=h;B(b);p[c]=b;b={TextColor:"#666666"};b.Text=c;b.Font="normal 11px Arial";b.textAlign="start";b.StartY=60;myFlowStyle&&(b.TextColor=myFlowStyle.hosts.drawdata.TextColor,b.Font=myFlowStyle.hosts.drawdata.Font,b.LineColor=myFlowStyle.hosts.drawdata.LineColor,b.LineWidth=myFlowStyle.hosts.drawdata.LineWidth);k=w(b);var d=f*m-k.width/2+10,g=f*m-20;0==f?(d=f*m,g=f*m):f==u-1&&(d=f*m-k.width+15,g=f*m-30);
b.StartX=d;v(b);q.push({x1:b.StartX,y1:b.StartY-10,x2:b.StartX+k.width,y2:b.StartY+10,type:"host"});f=e.uac[c];b={};b.ImageSrc=f&&f.image?"/img/gateways/"+f.image+".jpg":"/img/gateways/sipgateway.jpg";if(f&&f.agent&&myUserAgents)for(d=0;d<myUserAgents.length;d++)f.agent.match(myUserAgents[d].rule)&&(b.ImageSrc=myUserAgents[d].img);b.StartY=2;b.textAlign="start";b.StartX=g;D(b)});var h=h-130,r=h/(e.calldata.length-1?e.calldata.length-1:1);50>r&&(r=50);var t=0,n,y;angular.forEach(e.calldata,function(a){n=
p.hasOwnProperty(a.source_alias)?p[a.source_alias]:p[a.src_id];y=p.hasOwnProperty(a.destination_alias)?p[a.destination_alias]:p[a.dst_id];b={LineColor:"#000"};myFlowStyle&&myFlowStyle.calldata.drawdata.ReColor&&(b.LineColor=E(a.callid));b.LineWidth=1;b.StartX=n.StartX;b.StartY=t*r+110;b.EndX=y.StartX;b.EndY=t*r+110;C(b);b={};b.TextColor=a.msg_color;b.Text=""+(t+1)+": "+a.method_text;b.Font="12px Futura, Helvetica, Arial";k=w(b);b.StartY=t*r+107;b.StartX=n.StartX<y.StartX?n.StartX+20:n.StartX-20-k.width;
b.textAlign="start";myFlowStyle&&(b.Font=myFlowStyle.calldata.drawdata.Font);v(b);q.push({x1:b.StartX-10,y1:b.StartY-10,x2:b.StartX+k.width,y2:b.StartY+10,type:"message",data:a});b={TextColor:"#C0C0C0"};b.Text=F("date")(new Date(a.micro_ts/1E3),"yyyy-MM-dd HH:mm:ss.sss Z",d.offset);b.Font="lighter 8pt Arial";b.textAlign="start";k=w(b);b.StartY=t*r+122;b.StartX=n.StartX<y.StartX?n.StartX+20:n.StartX-20-k.width;t++;v(b)});return q}}}]).directive("canvasclick",["$homerModal",function(z){return{restrict:"EA",
link:function(u,d,z){d.on("click",function(d){u.clickMousePosition(d)});d.on("mousemove",function(q,z){u.checkMousePosition(q)?d.context.style.cursor="pointer":d.context.style.cursor="default"})}}}])})();
