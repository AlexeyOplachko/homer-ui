/*
 AGPLv2
 @author Alexandr Dubovikov <alexandr.dubovikov@gmail.com>

 Based on ocModal
 @author Olivier Combe <olivier.combe@gmail.com>
*/
(function(){angular.module("homer.cflow",[]).factory("$homerCflow",["$rootScope","$controller","$location","$timeout","$compile","$sniffer","$q","$filter",function(y,u,h,E,g,F,G,D){var z={},A,v,B,w,C,c;A=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.stroke()};B=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,
a.EndY);var e=Math.atan2(a.EndY-a.StartY,a.EndX-a.StartX);c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(e-Math.PI/6),a.EndY-10*Math.sin(e-Math.PI/6));c.moveTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(e+Math.PI/6),a.EndY-10*Math.sin(e+Math.PI/6));c.stroke()};v=function(a){c.beginPath();c.fillStyle=a.TextColor;c.font=a.Font;c.textAlign=a.textAlign;c.fillText(a.Text,a.StartX,a.StartY);c.stroke()};w=function(a){c.strokeStyle=a.TextColor;c.font=a.Font;return c.measureText(a.Text)};
C=function(a){c.beginPath();var e=new Image;e.src=a.ImageSrc;e.onload=function(){c.drawImage(e,a.StartX,a.StartY);c.stroke()}};return{waitingForOpen:!1,getOpenedModals:function(){return openedModals},register:function(a){z[a.id||"_default"]=a},remove:function(a){delete z[a||"_default"]},setContext:function(a,e){var h=[],m=angular.element(document.querySelectorAll("#"+a)),d=$(m).find("#cflowcanv")[0].getContext("2d");c=d;var k=$(m).height()-110,m=$(m).width()-20,g=e.calldata.length,g=g+3;50*g>k&&(k=
50*g);d.canvas.width=m;d.canvas.height=k;var q={},b={},l={width:0};d.clearRect(0,0,c.canvas.width,c.canvas.height);d.fillStyle="#FFF";d.opacity=.2;d.fillRect(0,0,c.canvas.width,c.canvas.height);var m=m-20,k=k-30,d=Object.keys(e.hosts).length-1,n=m/(d?d:1),u=Object.keys(e.hosts).length;angular.forEach(e.hosts,function(a,c){var f=parseInt(a.position);b={LineColor:"#000",LineWidth:1};b.StartX=f*n+10;b.StartY=65;b.EndX=f*n+10;b.EndY=k;A(b);q[c]=b;b={TextColor:"#666666"};b.Text=c;b.Font="normal 11px Arial";
b.textAlign="start";b.StartY=60;myFlowStyle&&(b.TextColor=myFlowStyle.hosts.drawdata.TextColor,b.Font=myFlowStyle.hosts.drawdata.Font);l=w(b);var d=f*n-l.width/2+10,g=f*n-20;0==f?(d=f*n,g=f*n):f==u-1&&(d=f*n-l.width+15,g=f*n-30);b.StartX=d;v(b);h.push({x1:b.StartX,y1:b.StartY-10,x2:b.StartX+l.width,y2:b.StartY+10,type:"host"});f=e.uac[c];b={};b.ImageSrc=f&&f.image?"/img/gateways/"+f.image+".jpg":"/img/gateways/sipgateway.jpg";if(f&&f.agent&&myUserAgents)for(d=0;d<myUserAgents.length;d++)f.agent.match(myUserAgents[d].rule)&&
(b.ImageSrc=myUserAgents[d].img);b.StartY=2;b.textAlign="start";b.StartX=g;C(b)});var k=k-130,r=k/(e.calldata.length-1?e.calldata.length-1:1);50>r&&(r=50);var t=0,p,x;angular.forEach(e.calldata,function(a){p=q.hasOwnProperty(a.source_alias)?q[a.source_alias]:q[a.src_id];x=q.hasOwnProperty(a.destination_alias)?q[a.destination_alias]:q[a.dst_id];b={LineColor:"#000",LineWidth:1};b.StartX=p.StartX;b.StartY=t*r+110;b.EndX=x.StartX;b.EndY=t*r+110;B(b);b={};b.TextColor=a.msg_color;b.Text=""+(t+1)+": "+a.method_text;
b.Font="12px Futura, Helvetica, Arial";l=w(b);b.StartY=t*r+107;b.StartX=p.StartX<x.StartX?p.StartX+20:p.StartX-20-l.width;b.textAlign="start";myFlowStyle&&(b.Font=myFlowStyle.calldata.drawdata.Font);v(b);h.push({x1:b.StartX-10,y1:b.StartY-10,x2:b.StartX+l.width,y2:b.StartY+10,type:"message",data:a});b={TextColor:"#C0C0C0"};b.Text=D("date")(new Date(a.micro_ts/1E3),"yyyy-MM-dd HH:mm:ss.sss");b.Font="lighter 8pt Arial";b.textAlign="start";l=w(b);b.StartY=t*r+122;b.StartX=p.StartX<x.StartX?p.StartX+
20:p.StartX-20-l.width;t++;v(b)});return h}}}]).directive("canvasclick",function(y){return{restrict:"EA",link:function(u,h,y){h.on("click",function(g){u.clickMousePosition(g)});h.on("mousemove",function(g,y){u.checkMousePosition(g)?h.context.style.cursor="pointer":h.context.style.cursor="default"})}}})})();
