/*
 AGPLv2
 @author Alexandr Dubovikov <alexandr.dubovikov@gmail.com>

 Based on ocModal
 @author Olivier Combe <olivier.combe@gmail.com>
*/
(function(){angular.module("homer.cflow",[]).factory("$homerCflow",["$rootScope","$controller","$location","$timeout","$compile","$sniffer","$q","$filter",function(z,v,g,F,q,G,H,E){var A={},B,w,C,x,D,c;B=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.stroke()};C=function(a){c.beginPath();c.strokeStyle=a.LineColor;c.lineWidth=a.LineWidth;c.lineCap="round";c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,
a.EndY);var d=Math.atan2(a.EndY-a.StartY,a.EndX-a.StartX);c.moveTo(a.StartX,a.StartY);c.lineTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(d-Math.PI/6),a.EndY-10*Math.sin(d-Math.PI/6));c.moveTo(a.EndX,a.EndY);c.lineTo(a.EndX-10*Math.cos(d+Math.PI/6),a.EndY-10*Math.sin(d+Math.PI/6));c.stroke()};w=function(a){c.beginPath();c.fillStyle=a.TextColor;c.font=a.Font;c.textAlign=a.textAlign;c.fillText(a.Text,a.StartX,a.StartY);c.stroke()};x=function(a){c.strokeStyle=a.TextColor;c.font=a.Font;return c.measureText(a.Text)};
D=function(a){c.beginPath();var d=new Image;d.src=a.ImageSrc;d.onload=function(){c.drawImage(d,a.StartX,a.StartY);c.stroke()}};return{waitingForOpen:!1,getOpenedModals:function(){return openedModals},register:function(a){A[a.id||"_default"]=a},remove:function(a){delete A[a||"_default"]},setContext:function(a,d){var g=[],l=angular.element(document.querySelectorAll("#"+a)),f=$(l).find("#cflowcanv")[0].getContext("2d");c=f;var h=$(l).height()-110,l=$(l).width()-20,q=d.calldata.length,q=q+3;50*q>h&&(h=
50*q);f.canvas.width=l;f.canvas.height=h;var r={},b={},k={width:0};f.clearRect(0,0,c.canvas.width,c.canvas.height);f.fillStyle="#FFF";f.opacity=.2;f.fillRect(0,0,c.canvas.width,c.canvas.height);var l=l-20,h=h-30,f=Object.keys(d.hosts).length-1,m=l/(f?f:1),v=Object.keys(d.hosts).length;angular.forEach(d.hosts,function(a,c){var e=parseInt(a.position);b={LineColor:"#000",LineWidth:1};b.StartX=e*m+10;b.StartY=65;b.EndX=e*m+10;b.EndY=h;B(b);r[c]=b;b={TextColor:"#666666"};b.Text=c;b.Font="normal 11px Arial";
b.textAlign="start";b.StartY=60;"undefined"!=myFlowStyle&&(b.TextColor=myFlowStyle.hosts.drawdata.TextColor,b.Font=myFlowStyle.hosts.drawdata.Font,b.LineColor=myFlowStyle.hosts.drawdata.LineColor,b.LineWidth=myFlowStyle.hosts.drawdata.LineWidth);k=x(b);var n=e*m-k.width/2+10,f=e*m-20;0==e?(n=e*m,f=e*m):e==v-1&&(n=e*m-k.width+15,f=e*m-30);b.StartX=n;w(b);g.push({x1:b.StartX,y1:b.StartY-10,x2:b.StartX+k.width,y2:b.StartY+10,type:"host"});e=d.uac[c];b={};b.ImageSrc=e&&e.image?"/img/gateways/"+e.image+
".jpg":"/img/gateways/sipgateway.jpg";if(e&&e.agent&&myUserAgents)for(n=0;n<myUserAgents.length;n++)e.agent.match(myUserAgents[n].rule)&&(b.ImageSrc=myUserAgents[n].img);b.StartY=2;b.textAlign="start";b.StartX=f;D(b)});var h=h-130,t=h/(d.calldata.length-1?d.calldata.length-1:1);50>t&&(t=50);var u=0,p,y;angular.forEach(d.calldata,function(a){p=r.hasOwnProperty(a.source_alias)?r[a.source_alias]:r[a.src_id];y=r.hasOwnProperty(a.destination_alias)?r[a.destination_alias]:r[a.dst_id];b={LineColor:"#000"};
if(myFlowStyle&&myFlowStyle.calldata.drawdata.ReColor){for(var c=b,e=a.callid,d=0,f=0;f<e.length;f++)d=e.charCodeAt(f)+((d<<5)-d);c.LineColor="hsl("+(d>>24&255)+", 75%, 35%)"}b.LineWidth=1;b.StartX=p.StartX;b.StartY=u*t+110;b.EndX=y.StartX;b.EndY=u*t+110;C(b);b={};b.TextColor=a.msg_color;b.Text=""+(u+1)+": "+a.method_text;b.Font="12px Futura, Helvetica, Arial";k=x(b);b.StartY=u*t+107;b.StartX=p.StartX<y.StartX?p.StartX+20:p.StartX-20-k.width;b.textAlign="start";myFlowStyle&&(b.Font=myFlowStyle.calldata.drawdata.Font);
w(b);g.push({x1:b.StartX-10,y1:b.StartY-10,x2:b.StartX+k.width,y2:b.StartY+10,type:"message",data:a});b={TextColor:"#C0C0C0"};b.Text=E("date")(new Date(a.micro_ts/1E3),"yyyy-MM-dd HH:mm:ss.sss");b.Font="lighter 8pt Arial";b.textAlign="start";k=x(b);b.StartY=u*t+122;b.StartX=p.StartX<y.StartX?p.StartX+20:p.StartX-20-k.width;u++;w(b)});return g}}}]).directive("canvasclick",function(z){return{restrict:"EA",link:function(v,g,z){g.on("click",function(g){v.clickMousePosition(g)});g.on("mousemove",function(q,
z){v.checkMousePosition(q)?g.context.style.cursor="pointer":g.context.style.cursor="default"})}}})})();
